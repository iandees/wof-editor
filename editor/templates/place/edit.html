{%- extends "_template.html" %}

{%- block title %}{{ super() }} : Edit {{ wof_doc.properties['wof:name'] or woc_doc.id }}{%- endblock %}

{%- block styles %}
{{ super() }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" integrity="sha384-NZLkVuBRMEeB4VeZz27WwTRvlhec30biQ8Xx7zG7JJnkvEKRg5qi6BNbEXo9ydwv"" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/@yaireo/tagify@2.31.6/dist/tagify.css" integrity="sha384-VgQsYt/GtydzxrFEKS4D9VXB6lLQ4cXbFwdorV5HIkxXY8N9e1gJCl36seX6wYYP" crossorigin=""/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@v0.79.0/dist/L.Control.Locate.min.css" integrity="sha384-s1weW3rLvQEcQo1OenCYWESkNoaaT6C995dZ4jgUAt+qkjhTNQoN8mhu6ZwQzWNS" crossorigin=""/>
<style type="text/css">
    #map {
        width: 100%;
        height: 300px;
        border-radius: 5px;
    }
</style>
{%- endblock %}

{%- block scripts %}
{{ super() }}
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-ajax@2.1.0/dist/leaflet.ajax.min.js" integrity="sha384-sKs8ZrrxyJoElcPVznZwGpUTTXvkMYfHYxdIFzO8Hd0TA6emONMj8BwnsFf+6cZ/" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js" integrity="sha384-JP5UPxIO2Tm2o79Fb0tGYMa44jkWar53aBoCbd8ah0+LcCDoohTIYr+zIXyfGIJN" crossorigin=""></script>
<script src="https://unpkg.com/@yaireo/tagify@2.31.6/dist/jQuery.tagify.min.js" integrity="sha384-oJRpUI+TNL56khhVpM5tcGH6Al77rv1qUUKXqmG0cMe5KtcNzLYfxgdcwunFouVe" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.locatecontrol@v0.79.0/dist/L.Control.Locate.min.js"  integrity="sha384-XF7O0sxpctKl96bCyBgbgdQbnHDg/ek0LdbWrVUmx/LPh4EDtdIsGculgF93z6wW" crossorigin=""></script>
<script type="text/javascript">
$(document).ready(function() {
    function checkValid(field) {
        let isValid = true;
        let formValue = $(field).val();
        let propertyName = $(field).data("wof-property-name");

        let regex = $(field).data("wof-validation-regex");
        let required = $(field).attr("required");
        if (regex) {
            if (formValue || required) {
                var matched = formValue.match(regex);

                if (!matched) {
                    $(field).addClass("is-invalid");
                    $(field).removeClass("is-valid");
                    isValid = false;
                } else {
                    $(field).addClass("is-valid");
                    $(field).removeClass("is-invalid");
                    isValid = true;
                }
            } else {
                // Remove valid/invalid if the value is not required and blank
                $(field).removeClass("is-valid");
                $(field).removeClass("is-invalid");
                isValid = true;
            }
        }

        return isValid;
    }

    var map = L.map('map', {preferCanvas: true});
    var baseLayer = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_toner_lite/{z}/{x}/{y}{r}.png', {
        attribution: 'Map tiles by &copy; <a href="https://stadiamaps.com/" target="_blank">Stadia Maps</a> <a href="https://stamen.com/" target="_blank">&copy; Stamen Design</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>',
        minZoom: 0,
        maxZoom: 19
    }).addTo(map);

    L.control.locate().addTo(map);

    var drawnItems = new L.FeatureGroup().addTo(map);

    var geomColors = {
        default: '#1f78b4',
        geomCentroid: '#a6cee3',
        labelPoint: '#33a02c',
        labelBbox: '#fb9a99',
        revgeoPoint: '#b2df8a',
    }
    
    // drawControl options are data dependent
    var count_circlemarker = 0;
    var count_polygon = 0;
    var count_rectangle = 0;
    var enable_circlemarker = true;
    var enable_polygon = true;
    var enable_rectangle = true;
    var has_default_geom_polygon = false;
    var has_default_geom_point = false;
    var has_math_centroid = false;
    var has_label_centroid = false;
    var has_label_bbox = false;
    var has_revGeo_centroid = false;
    var popup_text_default_geom_polygon = "default geometry (polygon)";
    var popup_text_default_geom_point = "default geometry (point)";
    var popup_text_math_centroid = "math centroid point";
    var popup_text_label_centroid = "label point";
    var popup_text_label_bbox = "label bounding box";
    var popup_text_revGeo_centroid = "reverse geocoding point";
    // TODO: Leaflet requires the layer overlays to be added in incrementing z-order
    //       If you want to reorder, you have to remove all and then add back (omg)
    //       The ideal z-ordering is below (not implemented)
    var options_default_geom_polygon = {color: geomColors.default, title: popup_text_default_geom_polygon};                     // zIndex: 100
    var options_default_geom_point = {color: geomColors.default, title: popup_text_default_geom_point};                         // zIndex: 203
    var options_math_centroid = {color: geomColors.geomCentroid, radius: 5, draggable: true, title: popup_text_math_centroid};  // zIndex: 200
    var options_label_centroid = {color: geomColors.labelPoint, draggable: true, title: popup_text_label_centroid};             // zIndex: 202
    var options_label_bbox = {color: geomColors.labelBbox, draggable: true, title: popup_text_label_bbox};                      // zIndex: 101
    var options_revGeo_centroid = {color: geomColors.revgeoPoint, draggable: true, title: popup_text_revGeo_centroid};          // zIndex: 201
    var z_offset_default_geom_polygon = 0;
    var z_offset_default_geom_point = 3;
    var z_offset_math_centroid = 0;
    var z_offset_label_centroid = 2;
    var z_offset_label_bbox = 1;
    var z_offset_revGeo_centroid = 1;
    
    $("#geometries_section").collapse();
    
    function drawGeoms() {
      count_circlemarker = 0;
      count_polygon = 0;
      count_rectangle = 0;
      has_default_geom_polygon = false;
      has_default_geom_point = false;
      has_math_centroid = false;
      has_label_centroid = false;
      has_label_bbox = false;
      has_revGeo_centroid = false;

      var featureLayer = L.geoJSON(null, {
          pointToLayer: function(pt, latlng) {
              has_default_geom_polygon = false;
              has_default_geom_point = true;
              return L.circleMarker(latlng, options_default_geom_point);
          },
          style: function(f) {
              return options_default_geom_polygon;
          },
      }).addTo(drawnItems);
      featureLayer.addData({{ {"type":"Feature","geometry":wof_doc.geometry}|tojson }});
      featureLayer.bindPopup(popup_text_default_geom_point);
      map.fitBounds(featureLayer.getBounds());
      // TODO: This is more complicated, depending on Polygon or Point we'd update text, too
      document.getElementById('geom_default').checked = true;
      document.getElementById('geom_default_text').value = "{{ wof_doc.geometry['coordinates'] }}";

      // Only enable polygon drawing if the default geom is a point not a polygon
      {% if wof_doc.geometry['type'] != 'Point' -%}
      featureLayer.bindPopup(popup_text_default_geom_polygon);
      count_polygon++;
      enable_polygon = false;
      has_default_geom_polygon = true;
      has_default_geom_point = false;
      {%- endif %}

      {%- if wof_doc.properties['lbl:bbox'] is defined %}
      {%- set bboxParts = wof_doc.properties['lbl:bbox'].split(",")|list -%}
      var labelBbox = L.latLngBounds(
          L.latLng({{ bboxParts[1] }}, {{ bboxParts[0] }}),
          L.latLng({{ bboxParts[3] }}, {{ bboxParts[2] }}),
      );
      var labelBboxLayer = L.rectangle(labelBbox, options_label_bbox ).addTo(drawnItems);
      map.fitBounds(featureLayer.getBounds().extend(labelBboxLayer.getBounds()));
      // Point default geoms sometimes have a label bounding box that is larger, zoom out to it
      labelBboxLayer.bindPopup(popup_text_label_bbox);
      // Disable drawing rectangles if the label bounding box already exists
      enable_rectangle = false;
      count_rectangle++;
      has_label_bbox = true;
      {%- endif %}
      document.getElementById('geom_label_bounding_box').checked = has_label_bbox;
      document.getElementById('geom_label_bounding_box_text').value = "{{ wof_doc.properties['lbl:bbox'] }}";

      {% if wof_doc.properties['geom:latitude'] is defined and wof_doc.properties['geom:longitude'] is defined -%}
      var geomCentroid = L.latLng({{ wof_doc.properties['geom:latitude']|float|tojson }}, {{ wof_doc.properties['geom:longitude']|float|tojson }});
      var geomCentroidLayer = L.circleMarker(geomCentroid, options_math_centroid).addTo(drawnItems);
      geomCentroidLayer.bindPopup(popup_text_math_centroid);
      // Add the CircleMarker to the drawnItems FeatureGroup to enable editing
      drawnItems.addLayer(geomCentroidLayer);
      has_math_centroid = true;
      document.getElementById('geom_math_centroid_text').value = "{{ wof_doc.properties['geom:longitude'] }}, {{ wof_doc.properties['geom:latitude'] }}";
      {%- else %}
      document.getElementById('geom_math_centroid_text').value = "";
      {%- endif %}
      document.getElementById('geom_math_centroid').checked = has_math_centroid;

      {% if wof_doc.properties['lbl:latitude'] is defined and wof_doc.properties['lbl:longitude'] is defined -%}
      var labelPoint = L.latLng({{ wof_doc.properties['lbl:latitude']|float|tojson }}, {{ wof_doc.properties['lbl:longitude']|float|tojson }});
      var labelPointLayer = L.circleMarker(labelPoint, options_label_centroid).addTo(drawnItems);
      labelPointLayer.bindPopup(popup_text_label_centroid);
      // Add the CircleMarker to the drawnItems FeatureGroup to enable editing
      drawnItems.addLayer(labelPointLayer);
      count_circlemarker++;
      has_label_centroid = true;
      document.getElementById('geom_label_centroid_text').value = "{{ wof_doc.properties['lbl:longitude'] }}, {{ wof_doc.properties['lbl:latitude'] }}";
      {%- else %}
      document.getElementById('geom_label_centroid_text').value = "";
      {%- endif %}
      document.getElementById('geom_label_centroid').checked = has_label_centroid;

      {% if wof_doc.properties['reversegeo:latitude'] is defined and wof_doc.properties['reversegeo:longitude'] is defined -%}
      var reverseGeo = L.latLng({{ wof_doc.properties['reversegeo:latitude']|float|tojson }}, {{ wof_doc.properties['reversegeo:longitude']|float|tojson }});
      var reverseGeoLayer = L.circleMarker(reverseGeo, options_revGeo_centroid).addTo(drawnItems);
      reverseGeoLayer.bindPopup(popup_text_revGeo_centroid);
      // Add the CircleMarker to the drawnItems FeatureGroup to enable editing
      drawnItems.addLayer(reverseGeoLayer);
      count_circlemarker++;
      has_revGeo_centroid = true;
      document.getElementById('geom_revgeo_centroid_text').value = "{{ wof_doc.properties['reversegeo:longitude'] }}, {{ wof_doc.properties['reversegeo:latitude'] }}";
      {%- else %}
      document.getElementById('geom_revgeo_centroid_text').value = "";
      {%- endif %}
      document.getElementById('geom_revgeo_centroid').checked = has_revGeo_centroid;

      {% if wof_doc.properties['lbl:latitude'] is defined and wof_doc.properties['lbl:longitude'] is defined and wof_doc.properties['reversegeo:latitude'] is defined and wof_doc.properties['reversegeo:longitude'] is defined -%}
      enable_circlemarker = false;
      {%- endif %}
    }
    
    drawGeoms();
    
    // Define a custom Leaflet control for the reset button
    var ResetButton = L.Control.extend({
      onAdd: function(map) {
        var button = L.DomUtil.create('button', 'leaflet-control-reset');
        button.innerHTML = 'Reset geometries';
        button.title = 'Reset geometries';

        L.DomEvent.on(button, 'click', function() {
          drawnItems.clearLayers();
          // Add your logic to restore earlier state if necessary
          drawGeoms();
          updateDrawOptions();
        });

        return button;
      }
    });

    // Create an instance of the custom control and add it to the map
    new ResetButton({ position: 'topright' }).addTo(map);

    var drawControl = new L.Control.Draw({
      position: 'topright',
      draw: {
        polyline: false,    // Remove line drawing option
        circle: false,
        marker: false,
        circlemarker: enable_circlemarker,
        polygon: enable_polygon,
        rectangle: enable_rectangle
      },
      edit: {
        featureGroup: drawnItems
      }
    });
    map.addControl(drawControl);
    
    function updateDrawOptions() {
      if( count_circlemarker >= 2 ) {
        drawControl.setDrawingOptions({ circlemarker: false });
      } else {
        drawControl.setDrawingOptions({ circlemarker: true });
      }
      if( count_polygon >= 1 ) {
        drawControl.setDrawingOptions({ polygon: false });
      } else {
        drawControl.setDrawingOptions({ polygon: true });
      }
      if( count_rectangle >= 1 ) {
        drawControl.setDrawingOptions({ rectangle: false });
      } else {
        drawControl.setDrawingOptions({ rectangle: true });
      }
      // to work around bug in the Leaflet Draw plugin, remove it and add it back for new options to take effect
      map.removeControl(drawControl);
      map.addControl(drawControl);
    }

    map.on('draw:created', function (e) {
      var layer = e.layer;
      
      if (layer instanceof L.CircleMarker) {
        if (count_circlemarker>=2) {
          map.removeLayer(layer);
          return;
        }
        circleMarkerAdded = true;
        drawControl.setDrawingOptions({ marker: false }); // Disable marker drawing option
        
        count_circlemarker++;
        updateDrawOptions();

        var labelPrompt = document.createElement('div');
        labelPrompt.innerHTML = `
          <p><b>Select the label type:</b></p>
        `;
        if( !has_label_centroid ) {
          // (nvkelso 20240329: whitespace in value + popup_text var is meaningful)
          labelPrompt.innerHTML += `
            <input type="radio" id="label" name="labelType" value="` + popup_text_label_centroid + `">
            <label for="label">Label Centroid</label><br>
          `;
        }
        if( !has_revGeo_centroid ) {
          labelPrompt.innerHTML += `
            <input type="radio" id="reverse" name="labelType" value="` + popup_text_revGeo_centroid + `">
            <label for="reverse">Reverse Geocoding Centroid</label><br>
          `;
        }
        labelPrompt.innerHTML += `
        <button id="submitLabelType">Submit</button>
        `;

        L.DomEvent.disableClickPropagation(labelPrompt);

        L.DomEvent.on(labelPrompt, 'click', function (e) {
          if (e.target.id === 'submitLabelType') {
            var selectedRadio = labelPrompt.querySelector('input[name="labelType"]:checked');
            if (selectedRadio) {
              labelType = selectedRadio.value;
              
              switch( labelType ) {
                case popup_text_label_centroid: 
                  has_label_centroid = true;
                  layer.setStyle( options_label_centroid );
                  document.getElementById('geom_label_centroid').checked = true;
                  document.getElementById('geom_label_centroid_text').value = `${layer.getLatLng().lng.toFixed(6)},${layer.getLatLng().lat.toFixed(6)}`;
                  break;
                case popup_text_revGeo_centroid: 
                  has_revGeo_centroid = true;
                  layer.setStyle(options_revGeo_centroid);
                  document.getElementById('geom_revgeo_centroid').checked = true;
                  document.getElementById('geom_revgeo_centroid_text').value = `${layer.getLatLng().lng.toFixed(6)},${layer.getLatLng().lat.toFixed(6)}`;
                  break;
                default:
                  //console.log( labelType );
                  break;
              }
              
              layer.options.title = labelType;
              layer.bindPopup(labelType);

              // TODO: Should block adding new circlemarkers until the dialog is submitted
              // TODO: Something here blocks editing of the added layer?
              drawnItems.addLayer(layer);
              map.removeControl(labelPrompt);
            } else {
              alert('Please select a label type.');
            }
          }
        });

        labelPrompt.style.position = 'absolute'; // Set position to absolute
        labelPrompt.style.top = '10px'; // Adjust top position
        labelPrompt.style.left = '10px'; // Adjust left position
        labelPrompt.style.zIndex = 1000; // Set higher z-index
        labelPrompt.style.backgroundColor = 'white'; // Set background color
        labelPrompt.style.border = '2px solid black'; // Set border
        labelPrompt.style.padding = '10px'; // Add padding
      
        map.getContainer().appendChild(labelPrompt);
      } else if (layer instanceof L.Rectangle) {
        // (nvkelso 20240329: Test Rectangle before Polygon because of Leaflet bug)
        layer.setStyle( options_label_bbox );
        layer.bindPopup(popup_text_label_bbox);
        document.getElementById('geom_label_bounding_box').checked = true;
        count_rectangle++;
        has_label_bbox = true;
        updateDrawOptions();
        // needs to be after GUI setting
        document.getElementById('geom_label_bounding_box_text').value = `${layer.getBounds().getWest().toFixed(6)},${layer.getBounds().getSouth().toFixed(6)},${layer.getBounds().getEast().toFixed(6)},${layer.getBounds().getNorth().toFixed(6)}`;
        drawnItems.addLayer(layer);
      } else if (layer instanceof L.Polygon) {
        layer.setStyle( options_default_geom_polygon );
        layer.bindPopup(popup_text_default_geom_polygon);
        document.getElementById('geom_default').checked = true;
        count_polygon++;
        has_default_geom_polygon = true;
        has_default_geom_point = false;
        updateDrawOptions();
        // needs to be after GUI setting
        document.getElementById('geom_default_text').value = layer.toGeoJSON()["geometry"]["coordinates"];
        // TODO: Will require moving the old default point geom to an alt (with new file), and source tracking
        drawnItems.addLayer(layer);
      }
    });

    map.on('draw:edited', function (e) {
      var layers = e.layers;
      layers.eachLayer(function (layer) {
        if (layer.options && layer.options.title) {
          console.log("Edited layer title:", layer.options.title);
        }
      });
    });
    $("input.wof-input").on("change", function() {
        checkValid($(this));
    });
    
    $("#geom_label_centroid_text").on("change", function(event) {
        console.log('TODO: Add label centroid at: ', event.target.value);
    });
    $("#geom_label_bounding_box_text").on("change", function(event) {
        console.log('TODO: Add label bbox: ', event.target.value);
    });
    $("#geom_revgeo_centroid_text").on("change", function(event) {
        console.log('TODO: Add revGeo centroid at: ', event.target.value);
    });
    
//     const inputElement = document.getElementById('geom_label_centroid');
//     inputElement.addEventListener('change', function(event) {
//       // Log the new value to the console
//       console.log('New value:', event.target.value);
//     });

    // Add event listener to modify label_centroid when a marker is deleted
    map.on('draw:deleted', function (e) {
      var layers = e.layers;
      layers.eachLayer(function (layer) {
        if (layer instanceof L.CircleMarker) {
          label_centroid = false;
          count_circlemarker--;
        }
        if (layer.options && layer.options.title) {
          console.log("Finished deleting layer title:", layer.options.title);
        
          switch( layer.options.title ) {
            case popup_text_label_centroid: 
              has_label_centroid = false;
              // TODO: Add setting of WOF geometry
              break;
            case popup_text_revGeo_centroid: 
              has_revGeo_centroid = false;
              // TODO: Add setting of WOF geometry
              break;
            case popup_text_label_bbox: 
              has_label_bbox = false;
              // TODO: Add setting of WOF geometry
              break;
            case popup_text_default_geom_polygon: 
            case popup_text_default_geom_point: 
            case popup_text_math_centroid: 
              // TODO: these should warn and the geom restored (and not removed from database)
              console.log("Ooops, this layer shouldn't be deleted:", layer.options.title);
              break;
            default:
              break;
          }
        }
        updateDrawOptions();
      });
    });

    // Add dropdown list for languages
    $('input.wof-input[name="wof:lang_x_spoken"]').tagify({
        allowlist: {{ lang_expansion.keys()|list|tojson }},
    });
    $('input.wof-input[name="wof:lang_x_official"]').tagify({
        allowlist: {{ lang_expansion.keys()|list|tojson }},
    });
    $('input.wof-input[name="wof:placetype_alt"]').tagify();
    $(".use-tagify").tagify({delimiters: null});

    // Set up a filter to pick which languages to show
    $("#alternate-names-selected").tagify({
        allowlist: {{ localized_names_tagify_allowlist|tojson }},
    }).on("add", function(e, tag) {
        var lang = tag.data.lang || tag.data.value;
        var existing = $(".localized-names-row[data-lang=\"" + lang + "\"]").first()
        if (existing.length > 0) {
            existing.show();
        } else {
            var newBlock = $("#localized-names-row-template").clone();
            newBlock.removeAttr("id");
            newBlock.attr("data-lang", lang);
            newBlock.find("div h4").text(lang);
            newBlock.find("div small code").text(lang);
            newBlock.find("input.form-control").attr("name", function(e) {
                return "name:" + lang + "_x_" + $(this).data("spec");
            });
            newBlock.show();
            newBlock.find("input.form-control").tagify({delimiters: null});
            newBlock.insertAfter($(".localized-names-row").last());
        }
    }).on("remove", function(e, tag) {
        var lang = tag.data.lang || tag.data.value;
        $(".localized-names-row[data-lang=\"" + lang + "\"]").hide();
    });

    // Default to showing English only
    $("#alternate-names-selected").data("tagify").addTags([{"lang": "eng", "value": "English (eng)"}]);

    // Set up a filter to pick which languages to show
    $("#localized-labels-selected").tagify({
        allowlist: {{ localized_labels_tagify_allowlist|tojson }},
    }).on("add", function(e, tag) {
        var lang = tag.data.lang || tag.data.value;
        var existing = $(".localized-labels-row[data-lang=\"" + lang + "\"]").first()
        if (existing.length > 0) {
            existing.show();
        } else {
            var newBlock = $("#localized-labels-row-template").clone();
            newBlock.removeAttr("id");
            newBlock.attr("data-lang", lang);
            newBlock.find("div h4").text(lang);
            newBlock.find("div small code").text(lang);
            newBlock.find("input.form-control").attr("name", function(e) {
                return "label:" + lang + "_x_" + $(this).data("spec");
            });
            newBlock.show();
            newBlock.find("input.form-control").tagify({delimiters: null});
            newBlock.insertAfter($(".localized-labels-row").last());
        }
    }).on("remove", function(e, tag) {
        var lang = tag.data.lang || tag.data.value;
        $(".localized-labels-row[data-lang=\"" + lang + "\"]").hide();
    });

    // Default to showing English only
    $("#localized-labels-selected").data("tagify").addTags([{"lang": "eng", "value": "English (eng)"}]);

    // // Toggle show/hide of geometries section
//     $("#show-hide-geoms").on("click", function(e) {
//       var x = document.getElementById("geometries_section");
//       if (x.style.display === "none") {
//         x.style.display = "block";
//       } else {
//         x.style.display = "none";
//       }
//     });

    // Perform validation before submitting form
    $("button[name=\"next-step\"]").on("click", function(e) {
        var anyFieldsInvalid = $("input.wof-input").toArray().some(function(eachElem, i) {
            return !checkValid(eachElem);
        });

        if (anyFieldsInvalid) {
            $("#flash-container").append('<div class="row"><div class="col-md-12"><div class="alert alert-danger alert-dismissible" role="alert">' +
                '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                'Some changes were not valid. Please check for errors below.</div></div></div>');
            $("html, body").scrollTop(0);

            e.preventDefault();
        }
    });

    $("#add-concordance").on("click", function(e) {
        var newRow = $("#new-concordance-row").clone();
        newRow.insertAfter($(".concordance-row").last());
        newRow.addClass("concordance-row");
        newRow.removeAttr("id");
        newRow.find('input[name="new-wof:concordances-name"]').attr("name", "new-wof:concordances-name" + $(".concordance-row").length);
        newRow.find('input[name="new-wof:concordances-value"]').attr("name", "new-wof:concordances-value" + $(".concordance-row").length);
        newRow.show();
    });
});
</script>
{%- endblock %}

{%- block content %}
<h3>Editing {{ wof_doc.properties['wof:name'] or wof_doc.id }}</h3><small>(<a href="https://spelunker.whosonfirst.org/id/{{ wof_doc.id }}/">View on Spelunker</a>)</small>

<div class="row col-md-12 mb-4">
    <div id="map"></div>
</div>

<form class="needs-validation" novalidate action="{{ url_for('place.edit_place', url=wof_url) }}" method="POST">
    <h4>Geometries</h4>
    <!-- TODO: This doesn't show/hide -->
    <!-- <button id="show-hide-geoms" class="btn btn-secondary">Hide geometries</button> -->
    <div id="geometries_section" class="geometries_section">
      <div class="form-group">
          <input type="checkbox" id="geom_default" name="geom_default" value="Default geom" disabled=True checked=True>
          {%- if wof_doc.properties['geom:area_square_m'] is defined %}
          <label for="geom_default">Default geometry</label>&nbsp;<small>({{ wof_doc.geometry['type'] }} <code>geometry["coordinates"]</code> sourced from <code>{{ wof_doc.properties['src:geom'] }}</code> is {{ wof_doc.properties['geom:area_square_m']|int }} square meters)</small>
          {%- else %}
          <label for="geom_default">Default geometry</label>&nbsp;<small>({{ wof_doc.geometry['type'] }} <code>geometry["coordinates"]</code> sourced from <code>{{ wof_doc.properties['src:geom'] }}</code>)</small>
          {%- endif %}
          <input type="input" id="geom_default_text" name="geom:coordinates" value="" class="form-control wof-input">
          <small id="wof-name-help" class="form-text text-muted">Land-only multi-polygons are preferred, points are allowed. If water is included, please add a land-based reverse geocoding centroid.</small>
      </div>
      <div class="form-group">
          {%- if wof_doc.properties['src:geom_alt'] is defined %}
          <input type="checkbox" id="geom_alternates" name="geom_alternates" value="Alternate geometries" disabled=True checked=True>
          <label for="geom_default">Alternate geometries</label>&nbsp;<small>(<code>src:geom_alt</code>)</small>
          <small id="wof-name-help" class="form-text text-muted">Alternate geometries are present from the following {{ wof_doc.properties['src:geom_alt']|length }} sources:</small>
          {%- for alt_geom in wof_doc.properties['src:geom_alt'] %}
          <ul class="form-text text-muted">
              <li><code>{{ alt_geom }}</code></li>
          </ul>
          {%- endfor %}
          {%- else %}
          <input type="checkbox" id="geom_alternates" name="geom_alternates" value="Alternate geometries" disabled=True>
          <label for="geom_default">Alternate geometries</label>&nbsp;<small>(<code>src:geom_alt</code>)</small>
          <small id="wof-name-help" class="form-text text-muted">Alternate geometries are allowed (none present).</small>
          {%- endif %}
      </div>
      <div class="form-group">
          {% if wof_doc.properties['geom:latitude'] is defined and wof_doc.properties['geom:longitude'] is defined -%}
          <input type="checkbox" id="geom_math_centroid" name="geom_math_centroid" value="Geometric centroid" disabled=True checked=True>
          {%- else %}
          <input type="checkbox" id="geom_math_centroid" name="geom_math_centroid" value="Geometric centroid" disabled=True>
          {%- endif %}
          <label for="geom_math_centroid">Math centroid</label>&nbsp;<small>(<code>geom:longitude</code>, <code>geom:latitude</code>)</small>
          <input disabled type="input" id="geom_math_centroid_text" name="geom:centroid" value="" class="form-control wof-input">
          <small id="wof-name-help" class="form-text text-muted">The location of a feature's geometric centroid (can be off the surface). Machine generated.</small>
      </div>
      <div class="form-group">
          {% if wof_doc.properties['lbl:latitude'] is defined and wof_doc.properties['lbl:longitude'] is defined -%}
          <input type="checkbox" id="geom_label_centroid" name="geom_label_centroid" value="Label centroid" checked=True>
          <label for="geom_label_centroid">Label centroid</label>&nbsp;<small>(<code>lbl:longitude</code>, <code>lbl:latitude</code>)</small>
          {%- else %}
          <input type="checkbox" id="geom_label_centroid" name="geom_label_centroid" value="Label centroid" disabled=True>
          <label for="geom_label_centroid">Label centroid</label>&nbsp;<small>(<code>lbl:longitude</code>, <code>lbl:latitude</code>)</small>
          {%- endif %}
          <input type="input" id="geom_label_centroid_text" name="lbl:centroid" value="" class="form-control wof-input" data-wof-validation-regex="^([-+]?[0-9]*\.?\d+),\s*([-+]?[0-9]*\.?\d+)$">
          <small id="wof-name-help" class="form-text text-muted">The coordinate that specifies a label's east-west position (longitude) and northâ€“south position (latitude). Human-generated or derived from mapshaper.</small>
      </div>
      <div class="form-group">
          {%- if wof_doc.properties['lbl:bbox'] is defined %}
          <input type="checkbox" id="geom_label_bounding_box" name="geom_label_bounding_box" value="Label bounding box" checked=True >
          {%- else %}
          <input type="checkbox" id="geom_label_bounding_box" name="geom_label_bounding_box" value="Label bounding box" disabled=True>
          {%- endif %}
          <label for="geom_label_bounding_box">Label bounding box</label>&nbsp;<small>(<code>lbl:bbox</code>)</small>
          <input type="input" id="geom_label_bounding_box_text" name="lbl:bbox" value="{{ wof_doc.properties['lbl:bbox'] }}" class="form-control wof-input" data-wof-validation-regex="^([-+]?[0-9]*\.?\d+),\s*([-+]?[0-9]*\.?\d+),\s*([-+]?[0-9]*\.?\d+),\s*([-+]?[0-9]*\.?\d+)$">
          <small id="wof-name-help" class="form-text text-muted">Used for map viewports and search. Usually smaller than the geom:bbox for polygons but larger for points. Human-generated.</small>
      </div>
      <div class="form-group">
          {% if wof_doc.properties['reversegeo:latitude'] is defined and wof_doc.properties['reversegeo:longitude'] is defined -%}
          <input type="checkbox" id="geom_revgeo_centroid" name="geom_revgeo_centroid" value="Reverse geocoding centroid" checked=True >
          <label for="geom_label_centroid">Reverse geocoding centroid</label>&nbsp;<small>(<code>reversegeo:longitude</code>, <code>reversegeo:latitude</code>)</small>
          {%- else %}
          <input type="checkbox" id="geom_revgeo_centroid" name="geom_revgeo_centroid" value="Reverse geocoding centroid" disabled=True>
          <label for="geom_label_centroid">Reverse geocoding centroid</label>&nbsp;<small>(<code>reversegeo:longitude</code>, <code>reversegeo:latitude</code>)</small>
          {%- endif %}
          <input type="input" id="geom_revgeo_centroid_text" name="reversegeo:centroid" value="" class="form-control wof-input" data-wof-validation-regex="^([-+]?[0-9]*\.?\d+),\s*([-+]?[0-9]*\.?\d+)$">
          <small id="wof-name-help" class="form-text text-muted">Represents the centroid to use when reverse geocoding a record to establish the parent hierarchy, preferably on land. Typically derived from mapshaper.</small>
      </div>
    </div>

    <h4>Common properties</h4>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/wof/name.json -->
    <div class="form-group">
        <label for="wof-name">Name</label>&nbsp;<small>(<code>wof:name</code>)</small>
        <input type="text" class="form-control wof-input" name="wof:name" data-wof-validation-regex="^.{1,}$" value="{{ wof_doc.properties['wof:name'] }}">
        <small id="wof-name-help" class="form-text text-muted">An English UTF-7 transliterated representation of the name. (Some features have UTF-8 names.)</small>
    </div>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/wof/placetype.json -->
    <div class="form-group">
        <label for="wof-placetype">Placetype</label>&nbsp;<small>(<code>wof:placetype</code>)</small>
        <input type="text" class="form-control wof-input" name="wof:placetype" disabled value="{{ wof_doc.properties['wof:placetype'] }}">
        <small id="wof-placetype-help" class="form-text text-muted">What WOF calls a record's administrative division type.</small>
    </div>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/wof/placetype_alt.json -->
    <div class="form-group">
        <label for="wof-placetype_alt">Alternate Placetypes</label>&nbsp;<small>(<code>wof:placetype_alt</code>)</small>
        <input type="text" class="form-control wof-input" name="wof:placetype_alt" data-wof-type="list" value='{{ (wof_doc.properties['wof:placetype_alt'] or [])|tojson }}'>
        <small id="wof-placetype_alt-help" class="form-text text-muted">A single placetype denoting alternate representations of a place (exclusive of the placetype value).</small>
    </div>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/wof/shortcode.json -->
    <div class="form-group">
        <label for="wof-shortcode">Shortcode</label>&nbsp;<small>(<code>wof:shortcode</code>)</small>
        <input type="text" class="form-control wof-input" name="wof:shortcode" data-wof-validation-regex="^[A-Za-z0-9]{2,3}$" value="{{ wof_doc.properties['wof:shortcode'] }}">
        <small id="wof-shortcode-help" class="form-text text-muted">A two or three character alphabetic code, preferring three characters for country, two characters for region, and either two or three characters for county.</small>
    </div>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/mz/is_current.json -->
    <div class="form-group">
        <label for="mz-is_current">Is Current</label>&nbsp;<small>(<code>mz:is_current</code>)</small>
        <input type="text" class="form-control wof-input" name="mz:is_current" data-wof-validation-regex="^(-1|0|1)$" value="{{ wof_doc.properties['mz:is_current'] }}">
        <small id="mz-is_current-help" class="form-text text-muted">Defaults to -1 when status is not known, set to 1 when we know a place is active, and 0 if it's closed.</small>
    </div>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/mz/is_funky.json -->
    <div class="form-group">
        <label for="mz-is_funky">Disabled</label>&nbsp;<small>(<code>mz:is_funky</code>)</small> 
        <input type="text" class="form-control wof-input" name="mz:is_funky" data-wof-validation-regex="^(-1|0|1)$" value="{{ wof_doc.properties['mz:is_funky'] }}">
        <small id="mz-is_funky-help" class="form-text text-muted">Used when Mapzen suspects the record is bad or inappropriate but additional confirmation is needed before the feature is deprecated. Records with a 1 value are recommended to be hidden from map display and search unless explicitly asked for by name.</small>
    </div>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/mz/hierarchy_label.json -->
    <div class="form-group">
        <label for="mz-hierarchy_label">Include in Hierarchy Label</label>&nbsp;<small>(<code>mz:hierarchy_label</code>)</small>
        <input type="text" class="form-control wof-input" name="mz:hierarchy_label" data-wof-validation-regex="^(-1|0|1)$" value="{{ wof_doc.properties['mz:hierarchy_label'] }}">
        <small id="mz-hierarchy_label-help" class="form-text text-muted">Used when generating place labels in geocoding software, like Pelias; this property defaults to True unless it is set to 0 manually. When Pelias decorates an address string, the hierarchy_label property is used to determine what is included in that address string.</small>
    </div>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/edtf/cessation.json -->
    <div class="form-group">
        <label for="edtf-cessation">Cessation</label>&nbsp;<small>(<code>edtf:cessation</code>)</small>
        <input type="text" class="form-control wof-input" name="edtf:cessation" value="{{ wof_doc.properties['edtf:cessation'] }}">
        <small id="edtf-cessation-help" class="form-text text-muted">Indicates when a place stopped being a going concern. The semantics for something ceasing may vary from placetype to placetype. For example, a venue may cease operations or a country may split in to multiple countries. Supports EDTF date notation like: 2000, 2000-01, 2000-01-01 and approximate dates like ~2000. Defaults to uuuu when unknown.</small>
    </div>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/edtf/deprecated.json -->
    <div class="form-group">
        <label for="edtf-deprecated">Deprecated</label>&nbsp;<small>(<code>edtf:deprecated</code>)</small>
        <input type="text" class="form-control wof-input" name="edtf:deprecated" value="{{ wof_doc.properties['edtf:deprecated'] }}">
        <small id="edtf-deprecated-help" class="form-text text-muted">Indicates the date when a place was determined to be invalid (was never a going concern). Supports EDTF date notation like: 2000, 2000-01, 2000-01-01 and approximate dates like ~2000. Defaults to uuuu when unknown.</small>
    </div>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/edtf/inception.json -->
    <div class="form-group">
        <label for="edtf-inception">Inception</label>&nbsp;<small>(<code>edtf:inception</code>)</small>
        <input type="text" class="form-control wof-input" name="edtf:inception" value="{{ wof_doc.properties['edtf:inception'] }}">
        <small id="edtf-inception-help" class="form-text text-muted">Indicates the date when a place was first created or established. Supports EDTF date notation like: 2000, 2000-01, 2000-01-01 and approximate dates like ~2000. Defaults to uuuu when unknown.</small>
    </div>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/edtf/superseded.json -->
    <div class="form-group">
        <label for="edtf-superseded">Superseded</label>&nbsp;<small>(<code>edtf:superseded</code>)</small>
        <input type="text" class="form-control wof-input" name="edtf:superseded" value="{{ wof_doc.properties['edtf:superseded'] }}">
        <small id="edtf-superseded-help" class="form-text text-muted">Indicates the date when a record was superseded by another record. Supports EDTF date notation like: 2000, 2000-01, 2000-01-01 and approximate dates like ~2000. Defaults to uuuu when unknown.</small>
    </div>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/wof/population.json -->
    <div class="form-group">
        <label for="wof-population">Population</label>&nbsp;<small>(<code>wof:population</code>)</small>
        <input type="text" class="form-control wof-input" name="wof:population" data-wof-validation-regex="^\d+$" value="{{ wof_doc.properties['wof:population'] }}">
        <small id="wof-population-help" class="form-text text-muted">An integer value to represent the most current, known population of a place.</small>
    </div>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/mz/min_zoom.json -->
    <div class="form-group">
        <label for="mz-min_zoom">Min Zoom</label>&nbsp;<small>(<code>mz:min_zoom</code>)</small>
        <input type="text" class="form-control wof-input" name="mz:min_zoom" data-wof-validation-regex="^\d+\.?\d*$" value="{{ wof_doc.properties['mz:min_zoom'] }}">
        <small id="mz-min_zoom-help" class="form-text text-muted">Float values (though in practice mosts are integer values) that match to web map zoom schema. Common range is 0.0 to 18.0, though they can be greater.</small>
    </div>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/mz/max_zoom.json -->
    <div class="form-group">
        <label for="mz-max_zoom">Max Zoom</label>&nbsp;<small>(<code>mz:max_zoom</code>)</small>
        <input type="text" class="form-control wof-input" name="mz:max_zoom" data-wof-validation-regex="^\d+\.?\d*$" value="{{ wof_doc.properties['mz:max_zoom'] }}">
        <small id="mz-max_zoom-help" class="form-text text-muted">Float values (though in practice mosts are integer values) that match to web map zoom schema. Common range is 0.0 to 18.0, though they can be greater.</small>
    </div>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/lbl/min_zoom.json -->
    <div class="form-group">
        <label for="lbl-min_zoom">Label Min Zoom</label>&nbsp;<small>(<code>lbl:min_zoom</code>)</small>
        <input type="text" class="form-control wof-input" name="lbl:min_zoom" data-wof-validation-regex="^\d+\.?\d*$" value="{{ wof_doc.properties['lbl:min_zoom'] }}">
        <small id="lbl-min_zoom-help" class="form-text text-muted">When the feature's label should first appear. Float values (though in practice mosts are integer values) that match to web map zoom schema. Common range is 0.0 to 18.0, though they can be greater.</small>
    </div>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/lbl/max_zoom.json -->
    <div class="form-group">
        <label for="lbl-max_zoom">Label Max Zoom</label>&nbsp;<small>(<code>lbl:max_zoom</code>)</small>
        <input type="text" class="form-control wof-input" name="lbl:max_zoom" data-wof-validation-regex="^\d+\.?\d*$" value="{{ wof_doc.properties['lbl:max_zoom'] }}">
        <small id="lbl-max_zoom-help" class="form-text text-muted">When the feature's label should be removed (or switched to a different representation like exterior ring labels). Float values (though in practice mosts are integer values) that match to web map zoom schema. Common range is 0.0 to 18.0, though they can be greater.</small>
    </div>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/wof/lang_x_spoken.json -->
    <div class="form-group">
        <label for="wof-lang_x_spoken">Spoken Languages</label>&nbsp;<small>(<code>wof:lang_x_spoken</code>)</small>
        <input type="text" class="form-control wof-input" name="wof:lang_x_spoken" data-wof-type="list" pattern="^[a-z]{3}$" value='{{ (wof_doc.properties['wof:lang_x_spoken'] or [])|tojson }}'>
        <small id="wof-lang_x_spoken-help" class="form-text text-muted">One or more ISO-639-3 language identifiers. These represent the languages, inclusive of official languages, spoken in the location of the corresponding WOF record.</small>
    </div>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/wof/lang_x_official.json -->
    <div class="form-group">
        <label for="wof-lang_x_official">Official Languages</label>&nbsp;<small>(<code>wof:lang_x_official</code>)</small>
        <input type="text" class="form-control wof-input" name="wof:lang_x_official" data-wof-type="list" pattern="^[a-z]{3}$" value='{{ (wof_doc.properties['wof:lang_x_official'] or [])|tojson }}'>
        <small id="wof-lang_x_official-help" class="form-text text-muted">One or more ISO-639-3 language identifiers. These represent the officially recognized languages of the location of the corresponding WOF record.</small>
    </div>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/wof/country.json -->
    <div class="form-group">
        <label for="wof-country">Country Code</label>&nbsp;<small>(<code>wof:country</code>)</small>
        <input type="text" disabled class="form-control wof-input" name="wof:country" data-wof-validation-regex="^[A-Za-z]{2}$" value="{{ wof_doc.properties['wof:country'] }}">
        <small id="wof-country-help" class="form-text text-muted">A two-letter country code from ISO 3166.</small>
    </div>
    <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/iso/country.json -->
    <div class="form-group">
        <label for="iso-country">ISO Country Code</label>&nbsp;<small>(<code>iso:country</code>)</small>
        <input type="text" disabled class="form-control wof-input" name="iso:country" data-wof-validation-regex="^[A-Za-z]{2}$" value="{{ wof_doc.properties['iso:country'] }}">
        <small id="iso-country-help" class="form-text text-muted">The two-letter country code from ISO 3166-1.</small>
    </div>

    <h4>Localized Names</h4>
    <div class="form-group">
        <label for="alternate-names-selected">Filter</label>
        <input type="text" class="form-control" id="alternate-names-selected">
        {%- if localized_names|length == 1 %}
        <small class="form-text text-muted">This place has localized names in 1 language. English is shown by default. Add more to the filter box to show more languages.</small>
        {%- else %}
        <small class="form-text text-muted">This place has localized names in {{ localized_names|length }} languages. English is shown by default. Add more to the filter box to show more languages.</small>
        {%- endif %}
    </div>
    <div class="form-group">
        {%- for lang, specs in localized_names.items() %}
        <div class="row localized-names-row" data-lang="{{ lang }}" style="display: none;">
            <div class="col-md-2"><h4>{{ lang_expansion.get(lang, lang) }}</h4><small>(<code>{{ lang }}</code>)</small></div>
            <div class="col-md-10">
                {%- for spec, expanded_spec in name_specs.items() %}
                <div class="form-group row">
                    <label class="col-md-2 col-form-label">{{ expanded_spec }}</label>
                    <div class="col-md-10">
                        <input name="name:{{ lang }}_x_{{ spec }}" data-spec="{{ spec }}" class="form-control use-tagify" value='{{ (localized_names[lang][spec] or [])|tojson }}' />
                    </div>
                </div>
                {%- endfor %}
            </div>
        </div>
        {%- endfor %}
        <div id="localized-names-row-template" class="row localized-names-row" data-lang="" style="display: none;">
            <div class="col-md-2"><h4></h4><small>(<code></code>)</small></div>
            <div class="col-md-10">
                {%- for spec, expanded_spec in name_specs.items() %}
                <div class="form-group row">
                    <label class="col-md-2 col-form-label">{{ expanded_spec }}</label>
                    <div class="col-md-10">
                        <input name="" data-spec="{{ spec }}" class="form-control" value="" />
                    </div>
                </div>
                {%- endfor %}
            </div>
        </div>
    </div>

    <h4>Localized Labels</h4>
    <div class="form-group">
        <label for="localized-labels-selected">Filter</label>
        <input type="text" class="form-control" id="localized-labels-selected">
        {%- if localized_labels|length == 1 %}
        <small class="form-text text-muted">This place has localized labels in 1 language. English is shown by default. Add more to the filter box to show more languages.</small>
        {%- else %}
        <small class="form-text text-muted">This place has localized labels in {{ localized_labels|length }} languages. English is shown by default. Add more to the filter box to show more languages.</small>
        {%- endif %}
    </div>
    <div class="form-group">
        {%- for lang, specs in localized_labels.items() %}
        <div class="row localized-labels-row" data-lang="{{ lang }}" style="display: none;">
            <div class="col-md-2"><h4>{{ lang_expansion.get(lang, lang) }}</h4><small>(<code>{{ lang }}</code>)</small></div>
            <div class="col-md-10">
                {%- for spec, expanded_spec in label_specs.items() %}
                <div class="form-group row">
                    <label class="col-md-2 col-form-label">{{ expanded_spec }}</label>
                    <div class="col-md-10">
                        <input name="label:{{ lang }}_x_{{ spec }}" data-spec="{{ spec }}" class="form-control use-tagify" value='{{ (localized_labels[lang][spec] or [])|tojson }}' />
                    </div>
                </div>
                {%- endfor %}
            </div>
        </div>
        {%- endfor %}
        <div id="localized-labels-row-template" class="row localized-labels-row" data-lang="" style="display: none;">
            <div class="col-md-2"><h4></h4><small>(<code></code>)</small></div>
            <div class="col-md-10">
                {%- for spec, expanded_spec in label_specs.items() %}
                <div class="form-group row">
                    <label class="col-md-2 col-form-label">{{ expanded_spec }}</label>
                    <div class="col-md-10">
                        <input name="" data-spec="{{ spec }}" class="form-control" value="" />
                    </div>
                </div>
                {%- endfor %}
            </div>
        </div>
    </div>

    <h4>Concordances</h4>
    <div class="form-group">
        {%- for k, v in (wof_doc.properties['wof:concordances'] or {}).items() %}
        <div class="form-group concordance-row">
            <div class="row">
                <label class="col-sm-4 col-form-label">{{ provider_expansion.get(k, k) }}&nbsp;<small>(<code>{{ k }}</code>)</small></label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" name="wof:concordances_x_{{ k }}" value="{{ v }}" />
                </div>
            </div>
        </div>
        {%- endfor %}
        <div id="new-concordance-row" class="form-group concordance-row">
            <div class="row">
                <div class="col-sm-4">
                    <input type="text" class="form-control" name="new-wof:concordances-name" placeholder="wd:id" />
                </div>
                <div class="col-sm-8">
                    <input type="text" class="form-control" name="new-wof:concordances-value" placeholder="Q1234" />
                </div>
            </div>
        </div>
        <div class="row">
            <button type="button" id="add-concordance" class="btn btn-sm btn-outline-primary">Add New Concordance</button>
        </div>
    </div>

    <div class="form-group">
        <button type="submit" name="next-step" value="pr" class="btn btn-primary">Propose Change on GitHub</button>
        <p class="help-block">Create a GitHub pull request with the changes you made above.</p>
    </div>
    <div class="form-group">
        <button type="submit" name="next-step" value="export" class="btn btn-secondary">Export Changes</button>
        <p class="help-block">Download the changes you made above as a properly-formatted Who's On First JSON document.</p>
    </div>
</form>
{%- endblock %}
