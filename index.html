<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://unpkg.com/bootstrap@4.4.1/dist/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="">
    <link rel="stylesheet" href="https://unpkg.com/@yaireo/tagify@2.31.6/dist/tagify.css" integrity="sha384-VgQsYt/GtydzxrFEKS4D9VXB6lLQ4cXbFwdorV5HIkxXY8N9e1gJCl36seX6wYYP" crossorigin=""/>
    <style>
    </style>

    <title>Who's On First Editor</title>
  </head>
  <body>
    <div class="container">
        <h1>Who's On First Editor</h1>
        <hr/>
        <h3>Editing <span id="place-name"></span></h3>

        <form>
            <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/wof/name.json -->
            <div class="form-group">
                <label for="wof-name">Name</label>&nbsp;<small>(<code>wof:name</code>)</small>
                <input type="text" class="form-control" id="wof-name">
                <small id="wof-name-help" class="form-text text-muted">An English UTF-7 transliterated representation of the name. (Some features have UTF-8 names.)</small>
            </div>
            <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/wof/shortcode.json -->
            <div class="form-group">
                <label for="wof-shortcode">Shortcode</label>&nbsp;<small>(<code>wof:shortcode</code>)</small>
                <input type="text" class="form-control" id="wof-shortcode">
                <small id="wof-shortcode-help" class="form-text text-muted">A two or three character alphabetic code, preferring three characters for country, two characters for region, and either two or three characters for county.</small>
            </div>
            <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/mz/is_current.json -->
            <div class="form-group">
                <label for="mz-is_current">Is Current</label>&nbsp;<small>(<code>mz:is_current</code>)</small>
                <input type="text" class="form-control" id="mz-is_current">
                <small id="mz-is_current-help" class="form-text text-muted"></small>
            </div>
            <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/edtf/cessation.json -->
            <div class="form-group">
                <label for="edtf-cessation">Cessation</label>&nbsp;<small>(<code>edtf:cessation</code>)</small>
                <input type="text" class="form-control" id="edtf-cessation">
                <small id="edtf-cessation-help" class="form-text text-muted">Indicates when a place stopped being a going concern. The semantics for something ceasing may vary from placetype to placetype. For example, a venue may cease operations or a country may split in to multiple countries.</small>
            </div>
            <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/edtf/deprecated.json -->
            <div class="form-group">
                <label for="edtf-deprecated">Deprecated</label>&nbsp;<small>(<code>edtf:deprecated</code>)</small>
                <input type="text" class="form-control" id="edtf-deprecated">
                <small id="edtf-deprecated-help" class="form-text text-muted">Indicates the date when a place was determined to be invalid (was never a going concern).</small>
            </div>
            <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/edtf/inception.json -->
            <div class="form-group">
                <label for="edtf-inception">Inception</label>&nbsp;<small>(<code>edtf:inception</code>)</small>
                <input type="text" class="form-control" id="edtf-inception">
                <small id="edtf-inception-help" class="form-text text-muted">Indicates the date when a place was first created or established.</small>
            </div>
            <!-- https://github.com/whosonfirst/whosonfirst-properties/blob/master/properties/edtf/superseded.json -->
            <div class="form-group">
                <label for="edtf-superseded">Superseded</label>&nbsp;<small>(<code>edtf:superseded</code>)</small>
                <input type="text" class="form-control" id="edtf-superseded">
                <small id="edtf-superseded-help" class="form-text text-muted">Indicates the date when a record was superseded by another record.</small>
            </div>

            <div class="form-group" id="alternate-names-placeholder">

            </div>
        </form>
    </div>

    <script src="https://unpkg.com/jquery@3.4.1/dist/jquery.min.js" integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh" crossorigin=""></script>
    <script src="https://unpkg.com/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin=""></script>
    <script src="https://unpkg.com/bootstrap@4.4.1/dist/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin=""></script>
    <script src="https://unpkg.com/@yaireo/tagify@2.31.6/dist/jQuery.tagify.min.js" integrity="sha384-oJRpUI+TNL56khhVpM5tcGH6Al77rv1qUUKXqmG0cMe5KtcNzLYfxgdcwunFouVe" crossorigin=""></script>
    <script src="languages.js"></script>
    <script type="text/javascript">
        function loadWofId(id) {
            var idAsString = id.toString();
            var idChunks = [];
            for (let i = 0; i < idAsString.length; i+=3) {
                const idChunk = idAsString.substring(i, i+3);
                idChunks.push(idChunk);
            }

            var idURLPrefix = idChunks.join("/");
            var url = "https://data.whosonfirst.org/" + idURLPrefix + "/" + idAsString + ".geojson";

            loadWofUrl(url);
        }

        function loadWofUrl(url) {
            $.getJSON(url, data => {
                populateForm(data);
            })
        }

        function buildAlternateTagify(prop, type, lang, displayName, values) {
            let formGroup = $('<div class="form-group row">');
            let inputSelect = $("<input>").
                attr("name", prop + "-" + type + "-" + lang).
                data("type", type).
                data("lang", lang).
                addClass(prop + "-select").
                addClass("form-control");
            formGroup.append($('<label class="col-sm-2 col-form-label">').text(displayName));
            formGroup.append($('<div class="col-sm-10">').append(inputSelect));
            inputSelect.tagify();
            if (values) {
                inputSelect.data('tagify').addTags(values);
            }

            return formGroup;
        }

        function populateForm(data) {
            $("#place-name").text(data.properties["wof:name"]);
            $("#wof-name").val(data.properties["wof:name"]);
            $("#wof-shortcode").val(data.properties["wof:shortcode"]);
            $("#mz-is_current").val(data.properties["mz:is_current"]);
            $("#edtf-cessation").val(data.properties["edtf:cessation"]);
            $("#edtf-deprecated").val(data.properties["edtf:deprecated"]);
            $("#edtf-inception").val(data.properties["edtf:inception"]);
            $("#edtf-superseded").val(data.properties["edtf:superseded"]);

            // Parse the alt names properties into a map of lang => {preferred, variant, etc}
            var alternateNamesByLang = {};
            Object.keys(data.properties).forEach(k => {
                if (!k.startsWith("name:")) {
                    return;
                }

                let withoutNamePrefix = k.substring(5);
                let keySplit = withoutNamePrefix.split("_x_");
                let lang = keySplit[0];
                let specifier = keySplit[1];
                let value = data.properties[k];

                if (!alternateNamesByLang.hasOwnProperty(lang)) {
                    alternateNamesByLang[lang] = {};
                }

                alternateNamesByLang[lang][specifier] = value;
            });

            // Add form rows for each language with select2 tag builders for each of preferred, variant, colloquial, etc.
            Object.keys(alternateNamesByLang).forEach(lang => {
                let properties = alternateNamesByLang[lang];

                let rowDiv = $('<div class="row">');

                // Language
                let langExpanded = languages[lang];
                if (!langExpanded) {
                    langExpanded = lang;
                }
                rowDiv.append($('<div class="col-md-2">').html('<h5>' + langExpanded + '</h5>(<code>' + lang + '</code>)'));

                let formSide = $('<div class="col-md-10">');

                formSide.append(buildAlternateTagify("alternate-names", "preferred", lang, "Preferred", properties.preferred));
                formSide.append(buildAlternateTagify("alternate-names", "variant", lang, "Variant", properties.variant));
                formSide.append(buildAlternateTagify("alternate-names", "colloquial", lang, "Colloquial", properties.colloquial));

                rowDiv.append(formSide);

                $("#alternate-names-placeholder").append(rowDiv);
            });
        }

        $(document).ready(function() {
            const urlParams = new URLSearchParams(window.location.search);
            var requestedID = urlParams.get("id");
            if (requestedID) {
                loadWofId(parseInt(requestedID));
            }
        });
    </script>
  </body>
</html>
